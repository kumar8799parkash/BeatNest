<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatNest</title>

    <link rel="stylesheet" href="css/utility.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/left.css">
    <link rel="stylesheet" href="css/right.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/mainSlider.css">
    <link rel="stylesheet" href="css/volumeSlider.css">
    <link rel="stylesheet" href="css/playlistPage.css">

    <style>

    </style>
</head>

<body>


    <header>
        <div class="logo-cont">
            <img class="cursor-pointer" src="images/logo.png" alt="">
            <div class="logo-text">BeatNest</div>
        </div>


        <div class="search-cont">
            <div class="hamburger-cont">
                <img src="svgs/hamburger.svg" alt="">
            </div>
            <div class="home-logo-cont cursor-pointer" id="home-logo-cont">
                <img src="svgs/home.svg" alt="">
            </div>

            <div class="search-input-cont">
                <img class="cursor-pointer" src="svgs/search.svg" alt="">
                <input type="text" placeholder="What do you want to play?">

                <div class="browse-img-cont flex justify-content align-items">
                    <div class="separation-cont">|</div>
                    <img class=" cursor-pointer" src="svgs/browse.svg" alt="">
                </div>

            </div>
        </div>


        <div class="right-nav-cont flex ">
            <div class="bell-cont flex justify-content align-items">
                <img class="cursor-pointer" src="svgs/bell.svg" alt="">
            </div>

            <div class="outer-profile-cont flex justify-content align-items">
                <div class="profile-cont cursor-pointer">P</div>
            </div>

        </div>

    </header>

    <main>
        <div class="left-cont" id="left-cont"></div>


        <div class="right-cont" id="right-cont"></div>

    </main>

    <footer>
        <div class="left-footer-cont">
            <div class="footer-image-cont"> <img id="footer-image" src="images/playlist images/playlistImage10.jpeg"
                    alt=""></div>
            <div class="footer-text-cont" id="footer-text-cont">Lorem, ipsum dolor sit amet consectetu</div>
            <div class="playing-svg-cont"><img src="images/playing.gif" alt=""></div>
        </div>
        <div class="right-footer-cont">

            <div class="top-footer-cont">
                <div class="buttons-cont">
                    <img src="images/musicButtons/backward.svg" alt="">
                    <img src="images/musicButtons/play.svg" alt="">
                    <img src="images/musicButtons/forward.svg" alt="">
                </div>
                <img class="loop-button" src="images/musicButtons/loop.svg" alt="">
                <div class="volume-cont">
                    <img src="svgs/speakerBlack.svg" alt="">
                    <input class="volume-slider" id="volume-slider" min="0" max="100" type="range">
                </div>
            </div>

            <div class="bottom-footer-cont">
                <input class="main-slider" step="any" id="main-slider" value="0" type="range">
            </div>
        </div>

    </footer>





    <script>

        function loadRightCont(targetPage) {
            fetch(`html/${targetPage}.html`)
                .then(response => {
                    return response.text();
                })
                .then(data => {
                    document.getElementById('right-cont').innerHTML = data;

                    const oldScript = document.getElementById('dynamic-script');
                    if (oldScript) oldScript.remove();

                    const pageScript = document.createElement('script');
                    pageScript.src = `scripts/${targetPage}.js`;
                    pageScript.defer = true;        //Delays execution until HTML is parsed. Improves performance.(optional)
                    pageScript.id = 'dynamic-script';  // 	Allows you to find/remove/replace this script easily in the DOM.(optional)

                    /*
                    What it does: Sets the id attribute of the <script> element to 'dynamic-script'.
                    Why it's used:
                    To uniquely identify the script tag

                    const oldScript = document.getElementById('dynamic-script');
                    if (oldScript) {
                        oldScript.remove(); // remove the previously loaded script
                    }
                    */

                    document.body.appendChild(pageScript);
                })
        }


        function loadLeftCont(targetPage) {
            fetch(`html/${targetPage}.html`)
                .then(response => {
                    return response.text();
                })
                .then(data => {
                    document.getElementById('left-cont').innerHTML = data;

                    const oldScript = document.getElementById('dynamic-script');
                    if (oldScript) oldScript.remove();

                    const pageScript = document.createElement('script');
                    pageScript.src = `scripts/${targetPage}.js`;
                    pageScript.defer = true;        //Delays execution until HTML is parsed. Improves performance.(optional)
                    pageScript.id = 'dynamic-script';  // 	Allows you to find/remove/replace this script easily in the DOM.(optional)

                    document.body.appendChild(pageScript);
                })
        }

        
        window.onload = () => {
            loadRightCont('home');
            loadLeftCont('leftCont');
        }


        homeLogoCont = document.getElementById('home-logo-cont');
        homeLogoCont.addEventListener('click', () => {
            loadRightCont('home');
        })

        /* artistCont = document.getElementsByClassName('artist-cont');
        Array.from(artistCont).forEach((artist, index) => {
            artist.addEventListener('click', () => {
                window.history.pushState({}, '', `?artistIndex=${index}`);
                loadRightCont('artistPage');
            })
        }) */

        const footerImage = document.getElementById('footer-image');
        const footerSongName = document.getElementById('footer-text-cont');
        const mainSlider = document.getElementById('main-slider');
        const volumeSlider = document.getElementById('volume-slider');


        let currentSound = null;
        let currentSongItem = null;
        let currentSongId = localStorage.getItem('currentSongId') || null;
        let currentSongImageSource = localStorage.getItem('currentSongImageSource') || null;
        let currentSongName = localStorage.getItem('currentSongName') || null;

        let songItems = document.getElementsByClassName('.song-item');

        if (currentSongImageSource) {
            footerImage.src = currentSongImageSource;
        }

        if (currentSongName) {
            footerSongName.textContent = currentSongName;
        }


        function updateSliderSmoothly() {
            if (currentSound && !currentSound.paused) {
                mainSlider.value = currentSound.currentTime;
                requestAnimationFrame(updateSliderSmoothly);
            }
        }

        const currentPlaylist = [];             // we set it when we finished appending all the song items of the clicked playlist
        let currentSongIndex = -1;

        function playSong(songItem, audioSource) {

            if (currentSound) {
                currentSound.pause();
                currentSound = null;
            }

            document.querySelectorAll('.active-song-bg').forEach(el => {
                el.classList.remove('active-song-bg');
            })

            currentSongId = songItem.dataset.id;
            localStorage.setItem('currentSongId', currentSongId);

            const songImage = songItem.querySelector('.song-cover-cont img').src;
            localStorage.setItem('currentSongImageSource', songImage);
            footerImage.src = songImage;

            const songName = songItem.querySelector('.song-name-cont').textContent;
            localStorage.setItem('currentSongName', songName);
            footerSongName.textContent = songName;

            currentSongItem = songItem;
            currentSongItem.classList.add("active-song-bg");

            currentSongIndex = currentPlaylist.indexOf(songItem);         // setting the index of the currently clicked song


            currentSound = new Audio(audioSource);
            currentSound.play();

            currentSound.addEventListener('loadedmetadata', () => {
                mainSlider.max = currentSound.duration;
            })

            mainSlider.addEventListener('input', () => {
                currentSound.currentTime = mainSlider.value;
            })

            volumeSlider.addEventListener('input', () => {
                if (currentSound) {
                    currentSound.volume = volumeSlider.value / 100;
                }
            })

            currentSound.addEventListener('loadedmetadata', () => {
                mainSlider.max = currentSound.duration;
                requestAnimationFrame(updateSliderSmoothly);
            })

            currentSound.addEventListener('ended', () => {
                currentSongIndex++ ;
                if(currentSongIndex >= currentPlaylist.length){
                    currentSongIndex = 0;
                }
                let nextSong = currentPlaylist[currentSongIndex];

                playSong(nextSong , nextSong.dataset.audio);
            })

        }





    </script>


</body>

</html>