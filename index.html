<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatNest - Web Music Player</title>

    <link rel="stylesheet" href="css/utility.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/left.css">
    <link rel="stylesheet" href="css/right.css">
    <link rel="stylesheet" href="css/footer.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/mainSlider.css">
    <link rel="stylesheet" href="css/volumeSlider.css">
    <link rel="stylesheet" href="css/playlistPage.css">
    <link rel="icon" href="public/favicon.png" type="image/png">

    <style>

    </style>
</head>

<body>


    <header>
        <div class="logo-cont">
            <img class="cursor-pointer logo-image" src="images/logo.png" alt="">
            <div class="logo-text">BeatNest</div>
        </div>


        <div class="search-cont">
            <div class="hamburger-cont">
                <img src="svgs/hamburger.svg" alt="">
            </div>
            <div class="home-logo-cont cursor-pointer" id="home-logo-cont">
                <img src="svgs/home.svg" alt="">
            </div>

            <div class="search-input-cont">
                <img class="cursor-pointer" src="svgs/search.svg" alt="">
                <input type="text" placeholder="What do you want to play?">

                <div class="browse-img-cont flex justify-content align-items">
                    <div class="separation-cont">|</div>
                    <img class=" cursor-pointer" src="svgs/browse.svg" alt="">
                </div>

            </div>
        </div>


        <div class="right-nav-cont flex ">

            <!-- <div class="bell-cont flex justify-content align-items" id="bell-cont">
                <img class="cursor-pointer" src="svgs/bell.svg" alt="">
            </div> -->

            <button class="sign-up-button" id="sign-up-button">Sign Up</button>
            <button class="log-in-button" id="log-in-button">Log in</button>

            <!-- <div class="outer-profile-cont flex justify-content align-items" id="outer-profile-cont">
                <div class="profile-cont cursor-pointer">P</div>
            </div> -->

        </div>

    </header>

    <main>
        <div class="left-cont" id="left-cont"></div>


        <div class="right-cont" id="right-cont"></div>
    </main>

    <footer>
        <div class="left-footer-cont">
            <!-- <div class="footer-image-cont"> <img id="footer-image" src="images/playlist images/playlistImage10.jpeg" alt=""></div> -->
            <div class="footer-image-cont"> <img id="footer-image" src="" alt=""></div>
            <div class="footer-text-cont" id="footer-text-cont">Lorem, ipsum dolor sit amet consectetu</div>
            <div class="playing-svg-cont"><img class="playing-svg-image" id="playing-svg-image" src="images/playing.gif"
                    alt=""></div>
        </div>
        <div class="right-footer-cont">

            <div class="top-footer-cont">
                <div class="buttons-cont">
                    <img id="backward-play-button" src="images/musicButtons/backward.svg" alt="">
                    <img id="play-pause-button" src="images/musicButtons/play.svg" alt="">
                    <img id="forward-play-button" src="images/musicButtons/forward.svg" alt="">
                </div>
                <img class="loop-button" src="images/musicButtons/loop.svg" alt="">
                <div class="volume-cont">
                    <img src="svgs/speakerBlack.svg" alt="">
                    <input class="volume-slider" id="volume-slider" min="0" max="100" type="range">
                </div>
            </div>

            <div class="bottom-footer-cont">
                <input class="main-slider" step="any" id="main-slider" value="0" type="range">
            </div>
        </div>

    </footer>


    <!-- WORKING OF CSS : link(or include) all the files inside the index.html and the respective css will be applied to the fetched html
    WORKING OF JS : -> js code will run as soon as browser encounter it, the best practice is to keep the script code inside functions as functions will be invoked by our wish(ie when we call them)
                    -> include(load) all the scripts in the index.html use defer keyword so that they do not run before html gets fully parsed
                    -> so inside different pages(like home.js, playlistPage.js), i have defined functions which i will run when needed
                    -> what does defer do?
                                by default, the browser downloads and executes the script immediately as it encounters it. This means:
                                HTML parsing pauses until the script finishes loading & running.
                                This can slow down page rendering if the script is large or the network is slow.

                                defer changes the behavior:
                                Script is downloaded in parallel with HTML parsing.
                                (It doesnâ€™t block the browser from continuing to read your HTML.)

                                Script execution is deferred until the HTML is completely parsed.
                                (So, it always runs after the DOM is ready, but before the DOMContentLoaded event.)

                                Execution order is preserved.
                                If you have multiple script defer they run in the order they appear in the HTML.

                                Difference vs. async
                                defer = waits until HTML is fully parsed, preserves order.
                                async = executes as soon as the script is downloaded, does not guarantee order. -->
    

    <script src="scripts/home.js" defer></script>
    <script src="scripts/playlistPage.js" defer></script>
    <script src="scripts/artistPage.js" defer></script>
    <script src="scripts/leftCont.js" defer></script>
    <script>

        const bellCont = document.getElementById("bell-cont");
        const signUpButton = document.getElementById("sign-up-button");
        const logInButton = document.getElementById("log-in-button");
        const outerProfileCont = document.getElementById("outer-profile-cont");  

        window.addEventListener("load", () => {
            const isUserExists = localStorage.getItem("beatNestToken");

            if(isUserExists){
                window.location.href = "./mainPage.html";
            }
        })


        signUpButton.addEventListener('click', () => {
            window.location.href = 'html/signUpPage.html'
        })

        logInButton.addEventListener('click', () => {
            window.location.href = 'html/loginPage.html'
        })


        function loadRightCont(targetPage) {
            fetch(`html/${targetPage}.html`)
                .then(response => {
                    return response.text();                         // .text() converts to String
                })
                .then(data => {
                    const rightCont = document.getElementById('right-cont');
                    rightCont.innerHTML = '';
                    rightCont.innerHTML = data;

                    if(targetPage == 'home') initHomePage();
                    else if(targetPage == 'playlistPage') initPlaylistPage();
                    else if(targetPage == 'artistPage') initArtistPage();

                    /* const oldScript = document.getElementById('right-dynamic-script');
                    if (oldScript) oldScript.remove();

                    const pageScript = document.createElement('script');
                    pageScript.src = `scripts/${targetPage}.js`;
                    pageScript.defer = true;        //Delays execution until HTML is parsed. Improves performance.(optional)
                    pageScript.id = 'right-dynamic-script';  // 	Allows you to find/remove/replace this script easily in the DOM.(optional) */

                    /*
                    What it does: Sets the id attribute of the <script> element to 'dynamic-script'.
                    Why it's used:
                    To uniquely identify the script tag

                    const oldScript = document.getElementById('dynamic-script');
                    if (oldScript) {
                        oldScript.remove(); // remove the previously loaded script
                    }
                    */

                    /* document.body.appendChild(pageScript); */
                })
        }


        function loadLeftCont(targetPage) {
            fetch(`html/${targetPage}.html`)
                .then(response => {
                    return response.text();
                })
                .then(data => {
                    document.getElementById('left-cont').innerHTML = data;

                    if(targetPage == 'leftCont') initLeftCont();
                    
                    
                    /* const oldScript = document.getElementById('left-dynamic-script');
                    if (oldScript) oldScript.remove();

                    const pageScript = document.createElement('script');
                    pageScript.src = `scripts/${targetPage}.js`;
                    pageScript.defer = true;        //Delays execution until HTML is parsed. Improves performance.(optional)
                    pageScript.id = 'left-dynamic-script';  // 	Allows you to find/remove/replace this script easily in the DOM.(optional)

                    document.body.appendChild(pageScript); */
                })
        }


        window.addEventListener("load", () => {
            loadRightCont('home');
            loadLeftCont('leftCont');
        })


        /*
        URL(uniform resource locator) looks like : protocol://hostname:port/pathname?queryString#hash
        */
        homeLogoCont = document.getElementById('home-logo-cont');
        homeLogoCont.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.searchParams.delete('playlistId');
            url.searchParams.delete('artistId');
            window.history.pushState({} , '' , url.pathname , url.search);
            loadRightCont('home');
        })

        /*
        When we are on home.js, and when user clicks on a particular playlist, this playlist's id get added to the url. and page changes to playlistPage.js(code is inside home.js)
        now we want that when user clicks on the backward button, then page should change to home.js again and when clicks on forward button, then page should change to that particular playlist page again

        to do this 'popstate' eventListener comes into play, 'popstate' triggers when:
                You press the Back button.
                You press the Forward button.
                You call history.back(), history.forward(), or history.go(n).
        **** it does not triggers on history.pushState() and history.replaceState().
        */

        window.addEventListener('popstate' , ()=>{
            const url = new URL(window.location.href);
            const playlistId = url.searchParams.get('playlistId');
            const artistId = url.searchParams.get('artistId');

            if(playlistId){
                loadRightCont('playlistPage');
            }
            else if(artistId){
                loadRightCont('artistPage');
            }
            else{
                loadRightCont('home');
            }
        })

        /* artistCont = document.getElementsByClassName('artist-cont');
        Array.from(artistCont).forEach((artist, index) => {
            artist.addEventListener('click', () => {
                window.history.pushState({}, '', `?artistIndex=${index}`);
                loadRightCont('artistPage');
            })
        }) */

        const footerImage = document.getElementById('footer-image');
        const footerSongName = document.getElementById('footer-text-cont');
        const mainSlider = document.getElementById('main-slider');
        const volumeSlider = document.getElementById('volume-slider');
        const backwardPlayButton = document.getElementById('backward-play-button');
        const forwardPlayButton = document.getElementById('forward-play-button');
        const playPauseButton = document.getElementById('play-pause-button');
        let playingSvgImage = document.getElementById('playing-svg-image');





        let currentSound = null;
        let currentSongItem = null;
        let currentSongId = localStorage.getItem('currentSongId') || null;
        let currentSongImageSource = localStorage.getItem('currentSongImageSource') || null;
        let currentSongName = localStorage.getItem('currentSongName') || null;


        if (currentSongImageSource) {
            footerImage.src = currentSongImageSource;
        }  

        if (currentSongName) {
            footerSongName.textContent = currentSongName;
        }


        function updateSliderSmoothly() {
            if (currentSound && !currentSound.paused) {
                mainSlider.value = currentSound.currentTime;
                requestAnimationFrame(updateSliderSmoothly);
            }
        }


        function playSong(songItem, audioSource) {

            if (currentSound) {
                currentSound.pause();
                currentSound = null;
            }

            document.querySelectorAll('.active-song-bg').forEach(el => {
                el.classList.remove('active-song-bg');
            })

            currentSongId = songItem.dataset.id;
            localStorage.setItem('currentSongId', currentSongId);

            const songImage = songItem.querySelector('.song-cover-cont img').src;
            localStorage.setItem('currentSongImageSource', songImage);
            footerImage.src = songImage;

            const songName = songItem.querySelector('.song-name-cont').textContent;
            localStorage.setItem('currentSongName', songName);
            footerSongName.textContent = songName;

            currentSongItem = songItem;
            currentSongItem.classList.add("active-song-bg");


            const playlistContainer = songItem.closest('.song-items-cont');
            currentPlaylist = Array.from(playlistContainer.querySelectorAll('.song-item'));


            currentSound = new Audio(audioSource);
            currentSound.play();

            currentSound.addEventListener('playing', () => {
                playingSvgImage.classList.add('full-opacity');
                playPauseButton.src = "images/musicButtons/pause.svg";
            })


            currentSound.addEventListener('ended', () => {
                nextPlay();
                playingSvgImage.classList.remove('full-opacity');
                playPauseButton.src = "images/musicButtons/play.svg";
            })


            currentSound.addEventListener('loadedmetadata', () => {
                mainSlider.max = currentSound.duration;
            })

            mainSlider.addEventListener('input', () => {
                currentSound.currentTime = mainSlider.value;
            })

            volumeSlider.addEventListener('input', () => {
                if (currentSound) {
                    currentSound.volume = volumeSlider.value / 100;
                }
            })

            currentSound.addEventListener('loadedmetadata', () => {
                mainSlider.max = currentSound.duration;
                requestAnimationFrame(updateSliderSmoothly);
            })

        }

        playPauseButton.addEventListener('click', () => {
            if (currentSound && !currentSound.paused && !currentSound.ended) {
                currentSound.pause();
                playPauseButton.src = "images/musicButtons/play.svg";
                playingSvgImage.classList.remove('full-opacity');
            }
            else if (currentSound) {
                currentSound.play();
                playPauseButton.src = "images/musicButtons/pause.svg";
                playingSvgImage.classList.add('full-opacity');
                requestAnimationFrame(updateSliderSmoothly);
            }
        })


        function nextPlay() {
            let len = currentPlaylist.length;
            let currentIndex = currentPlaylist.findIndex(song => song.dataset.id === currentSongItem.dataset.id);
            nextIndex = (currentIndex + 1) % len;
            let nextSong = currentPlaylist[nextIndex];
            let nextAudioSrc = nextSong.dataset.audio;
            playSong(nextSong, nextAudioSrc, currentPlaylist);
        }


        function previousPlay() {
            let len = currentPlaylist.length;
            let currentIndex = currentPlaylist.findIndex(song => song.dataset.id === currentSongItem.dataset.id);
            prevIndex = (currentIndex - 1 + len) % len;
            let prevSong = currentPlaylist[prevIndex];
            let prevAudioSrc = prevSong.dataset.audio;
            playSong(prevSong, prevAudioSrc, currentPlaylist);
        }


        forwardPlayButton.addEventListener('click', () => { nextPlay() });
        backwardPlayButton.addEventListener('click', () => { previousPlay() });

    </script>


</body>

</html>